# Система KPI - Финальная версия

## Обзор системы

Система KPI была полностью переработана и интегрирована с реальными данными из базы данных. Новая система использует 7 основных метрик для оценки эффективности преподавателей.

## Основные метрики KPI

### 1. Постоянные метрики (автоматический расчет)

#### Прогресс ученика по контрольным работам (20%)
- **Источник данных**: таблица `LessonResult` с типом урока `CONTROL_WORK`
- **Расчет**: процент оценок ≥4 из всех контрольных работ
- **Цель**: 85%
- **Статус**: ✅ Реализовано

#### Заполнение журнала (15%)
- **Источник данных**: таблица `LessonResult` с оценками и посещаемостью
- **Расчет**: процент уроков с выставленными оценками или отмеченной посещаемостью
- **Цель**: 95%
- **Статус**: ✅ Реализовано

#### Заполнение плана работ (КТП) (15%)
- **Источник данных**: таблица `CurriculumPlan`
- **Расчет**: средний процент выполнения КТП
- **Цель**: 90%
- **Статус**: ✅ Реализовано

#### Заполнение уроков дополнительным материалом (15%)
- **Источник данных**: таблица `Lesson` с полем `materials`
- **Расчет**: процент уроков с прикрепленными материалами
- **Цель**: 80%
- **Статус**: ✅ Реализовано

#### Обратная связь родителю (15%)
- **Источник данных**: таблицы `ChatRoom`, `ChatMessage`, связь через студентов
- **Расчет**: среднее время ответа преподавателя на сообщения родителей
- **Оценка**: ≤2 часа = 100 баллов, ≤6 часов = 90 баллов
- **Цель**: 85%
- **Статус**: ✅ Реализовано

#### Отзывы от родителей (10%)
- **Источник данных**: таблица `FeedbackResponse` от родителей студентов преподавателя
- **Расчет**: анализ числовых оценок в отзывах родителей
- **Цель**: 80%
- **Статус**: ✅ Реализовано

#### Процент удержания учеников (10%)
- **Источник данных**: активность студентов в `LessonResult` за последние 30 дней
- **Расчет**: процент студентов с активностью в последний месяц
- **Цель**: 90%
- **Статус**: ✅ Реализовано

### 2. Периодические метрики (ручное заполнение, бонусы)

#### Призовые места на олимпиадах (бонус)
- **Таблица**: `OlympiadResult`
- **Баллы**: зависят от уровня и места
- **Статус**: ✅ Реализовано

#### Поступление в РФМШ/НИШ/БИЛ (бонус)
- **Таблица**: `StudentAdmission`
- **Баллы**: зависят от типа учебного заведения
- **Статус**: ✅ Реализовано

#### Повышение квалификации (бонус)
- **Таблица**: `TeacherAchievement`
- **Тип**: `QUALIFICATION`
- **Статус**: ✅ Реализовано

## Архитектура системы

### Backend (NestJS)

#### KPI Service
```typescript
// apps/backend/src/kpi/kpi.service.ts
- getOverview(): общие метрики
- getTeacherKpi(): KPI по преподавателям
- calculateTeacherMetrics(): расчет всех метрик для преподавателя
- calculateOverallScore(): общий балл на основе весов
- manualKpiRecalculation(): ручной пересчет KPI
```

#### KPI Controller
```typescript
// apps/backend/src/kpi/kpi.controller.ts
- GET /kpi/overview
- GET /kpi/teachers
- GET /kpi/teachers/:id/details
- POST /kpi/recalculate
- GET /kpi/export
- POST /kpi/achievements
- GET /kpi/settings
- PUT /kpi/settings
```

### Frontend (React)

#### KPI Page
```typescript
// apps/frontend/src/pages/KPI.tsx
- Общий dashboard с метриками
- Таблица преподавателей с рейтингом
- Детальные модальные окна
- Графики и визуализации
- Экспорт данных
```

#### KPI Service
```typescript
// apps/frontend/src/services/kpiService.ts
- API клиент для работы с backend
- Экспорт в Excel/PDF
- Управление настройками
```

### База данных (Prisma)

#### Основные модели
```prisma
model TeacherAchievement {
  // Достижения преподавателей
}

model OlympiadResult {
  // Результаты олимпиад
}

model StudentAdmission {
  // Поступления учеников
}

model CurriculumPlan {
  // КТП с процентом выполнения
}
```

## Алгоритм расчета KPI

### 1. Автоматические метрики

```typescript
// Для каждого преподавателя:
const metrics = {
  controlWorksProgress: calculateStudentControlWorksProgress(teacherId),
  journalFilling: calculateJournalFilling(teacherId),
  workPlanFilling: calculateWorkPlanFilling(teacherId),
  lessonMaterials: calculateLessonMaterials(teacherId),
  parentResponse: calculateParentResponse(teacherId),
  parentFeedback: calculateParentFeedback(teacherId),
  studentRetention: calculateStudentRetention(teacherId)
};

// Общий балл с учетом весов:
const overallScore = calculateOverallScore(metrics, settings);
```

### 2. Система оценки

- **85-100**: Высокий уровень (зеленый)
- **70-84**: Средний уровень (синий)
- **50-69**: Требует внимания (желтый)
- **<50**: Критический уровень (красный)
- **-1**: В разработке (серый)

## Интерфейс пользователя

### Главная страница KPI

1. **Общие метрики**: карточки с ключевыми показателями
2. **Фильтры**: поиск, отделы, периоды
3. **Графики**: 
   - Распределение по уровням KPI
   - Средние показатели по метрикам
   - Тренды по времени
4. **Таблица преподавателей**: рейтинг с детальными показателями
5. **Детальные модальные окна**: радар-график, прогресс-бары

### Настройки KPI

1. **Веса метрик**: настройка важности каждой метрики
2. **Целевые значения**: установка целей для каждого показателя
3. **Периоды расчета**: настройка частоты обновления
4. **Уведомления**: автоматические уведомления

## Экспорт и отчеты

### Форматы экспорта
- **Excel (XLSX)**: детальные таблицы с данными
- **PDF**: готовые отчеты с графиками
- **CSV**: данные для анализа

### Типы отчетов
1. **Общий отчет KPI**: все преподаватели и метрики
2. **Индивидуальный отчет**: детальная информация по преподавателю
3. **Отчет по периоду**: сравнение показателей во времени

## Система достижений

### Автоматическое создание достижений
```typescript
// При добавлении результата олимпиады:
await createAchievement({
  teacherId: teacherId,
  type: 'OLYMPIAD_WIN',
  title: `Призовое место на олимпиаде: ${olympiadName}`,
  points: calculateOlympiadPoints(level, place)
});
```

### Расчет баллов
- **Международные олимпиады**: 30-50 баллов
- **Республиканские**: 18-30 баллов
- **Городские**: 12-20 баллов
- **Поступления в РФМШ/НИШ**: 35-40 баллов
- **Поступления в лицеи**: 15-20 баллов

## Безопасность и авторизация

### Роли и доступы
- **ADMIN**: полный доступ к системе
- **HR**: просмотр и управление KPI
- **TEACHER**: просмотр собственных показателей
- **PARENT**: ограниченный доступ к отзывам

### Защита данных
- Аутентификация через JWT токены
- Авторизация на уровне контроллеров
- Валидация входных данных
- Маскирование чувствительной информации

## Производительность

### Оптимизации
1. **Индексы в базе данных** на часто используемые поля
2. **Кэширование** результатов расчетов
3. **Пагинация** для больших списков
4. **Асинхронные операции** для тяжелых расчетов

### Мониторинг
- Логирование времени выполнения запросов
- Метрики использования API
- Алерты при превышении времени ответа

## Планы развития

### Краткосрочные задачи
1. ✅ Интеграция с системой чатов для метрики "Обратная связь родителям"
2. ✅ Улучшение алгоритма расчета удержания учеников
3. ✅ Добавление системы достижений и бонусов
4. ✅ Экспорт отчетов в различных форматах

### Среднесрочные задачи
1. 🔄 Добавление метрик по профессиональному развитию
2. 🔄 Интеграция с внешними системами оценки
3. 🔄 Автоматические уведомления и рекомендации
4. 🔄 Мобильное приложение для преподавателей

### Долгосрочные задачи
1. 📋 Машинное обучение для прогнозирования KPI
2. 📋 Интеграция с системами видеоаналитики
3. 📋 Blockchain для верификации достижений
4. 📋 API для интеграции с внешними платформами

## Техническая документация

### Установка и настройка

```bash
# Backend
cd apps/backend
pnpm install
npx prisma generate
npx prisma db push

# Frontend  
cd apps/frontend
pnpm install
pnpm run dev
```

### Переменные окружения

```env
# Backend
DATABASE_URL="postgresql://user:password@localhost:5432/abai"
JWT_SECRET="your-secret-key"

# Frontend
VITE_API_URL="http://localhost:3001"
```

### API Endpoints

```
GET /api/kpi/overview - Общая статистика
GET /api/kpi/teachers - KPI преподавателей
GET /api/kpi/teachers/:id/details - Детальная информация
POST /api/kpi/recalculate - Пересчет KPI
GET /api/kpi/export - Экспорт данных
POST /api/kpi/achievements - Создание достижения
GET /api/kpi/settings - Настройки KPI
PUT /api/kpi/settings - Обновление настроек
```

## Заключение

Система KPI полностью интегрирована с реальными данными и готова к производственному использованию. Все основные метрики работают с реальными данными из базы, реализована система достижений, экспорт отчетов и гибкие настройки.

**Статус проекта**: ✅ Готово к продакшену

**Последнее обновление**: 04.08.2025

**Версия**: 2.0.0
