# Интерфейс редактирования КТП

## Обзор
Добавлен полнофункциональный интерфейс для редактирования календарно-тематического планирования (КТП) в компоненте `KtpTreeView`. Интерфейс позволяет создавать, редактировать и удалять разделы и уроки КТП с автоматическим пересчетом академических часов.

## Основные возможности

### 1. Управление разделами КТП
- **Создание новых разделов**: Кнопка "Добавить новый раздел" в верхней части интерфейса
- **Редактирование разделов**: Кнопка редактирования (иконка карандаша) в правом верхнем углу каждого раздела
- **Удаление разделов**: Кнопка удаления (иконка корзины) с подтверждением
- **Автоматический расчет часов**: При добавлении/удалении уроков автоматически пересчитывается общее количество часов раздела

### 2. Управление уроками
- **Создание новых уроков**: Кнопка "Добавить урок в раздел" внутри каждого развернутого раздела
- **Редактирование уроков**: Кнопка редактирования в правом верхнем углу каждого урока
- **Удаление уроков**: Кнопка удаления при редактировании урока с подтверждением
- **Подробная форма урока**: Включает все поля урока (название, описание, цели, методы, материалы, оценивание, домашнее задание)

### 3. Интеграция с системными настройками
- **Настраиваемый академический час**: Автоматическая загрузка продолжительности академического часа из системных настроек
- **Корректные расчеты**: Все расчеты учитывают настроенную продолжительность академического часа
- **Консистентность данных**: Обеспечивается согласованность между КТП и системой отчетности

## Структура компонента

### Основные состояния
```typescript
const [ktpData, setKtpData] = useState<KtpData | null>(null);
const [editingSection, setEditingSection] = useState<number | null>(null);
const [editingLesson, setEditingLesson] = useState<number | null>(null);
const [showAddSectionForm, setShowAddSectionForm] = useState(false);
const [showAddLessonForm, setShowAddLessonForm] = useState<number | null>(null);
const [academicHourDuration, setAcademicHourDuration] = useState<number>(45);
```

### Основные функции

#### Управление разделами
- `handleEditSection(section)` - Переход в режим редактирования раздела
- `handleSaveSection()` - Сохранение изменений раздела
- `handleAddSection()` - Создание нового раздела
- `handleDeleteSection(sectionId)` - Удаление раздела с подтверждением

#### Управление уроками
- `handleEditLesson(lesson)` - Переход в режим редактирования урока
- `handleSaveLesson()` - Сохранение изменений урока
- `handleAddLesson(sectionId)` - Создание нового урока в разделе
- `handleDeleteLesson(lessonId)` - Удаление урока с подтверждением

#### Системные функции
- `loadAcademicHourDuration()` - Загрузка настройки академического часа
- `recalculateSectionHours(lessons)` - Пересчет общих часов раздела

## Формы редактирования

### Форма раздела
- **Название раздела** - обязательное поле
- **Описание** - опциональное текстовое поле
- **Всего часов** - автоматически рассчитывается на основе уроков

### Форма урока (расширенная)
- **Основная информация**:
  - Название урока (обязательное)
  - Длительность в академических часах
  - Неделя проведения
  - Дата проведения
- **Содержание**:
  - Описание урока
  - Цели урока (каждая цель с новой строки)
  - Методы обучения (через запятую)
  - Материалы урока (через запятую)
- **Оценивание**:
  - Способ оценивания
  - Домашнее задание

## Автоматические расчеты

### Пересчет часов раздела
При любых изменениях в уроках (добавление, редактирование, удаление) автоматически пересчитывается `totalHours` раздела:

```typescript
const recalculateSectionHours = (lessons: KtpLesson[]): number => {
  return lessons.reduce((total, lesson) => total + lesson.duration, 0);
};
```

### Интеграция с академическими часами
Компонент загружает настройку продолжительности академического часа из системных настроек и использует её для корректных расчетов:

```typescript
const loadAcademicHourDuration = async () => {
  try {
    const result = await systemService.getAcademicHourDuration();
    setAcademicHourDuration(result.minutes);
  } catch (error) {
    setAcademicHourDuration(45); // значение по умолчанию
  }
};
```

## Условия доступа

Интерфейс редактирования активируется через пропс `canEdit`:

```typescript
interface KtpTreeViewProps {
  ktpId?: number;
  ktpData?: KtpData;
  canEdit?: boolean; // Включает режим редактирования
}
```

## Визуальные индикаторы

### Состояния редактирования
- **Режим просмотра**: Обычное отображение разделов и уроков
- **Режим редактирования раздела**: Форма редактирования с синей рамкой
- **Режим редактирования урока**: Расширенная форма редактирования с синей рамкой
- **Режим добавления**: Формы добавления с зеленой рамкой

### Кнопки действий
- **Редактирование**: Иконка карандаша (FaEdit)
- **Удаление**: Иконка корзины (FaTrash)
- **Добавление**: Иконка плюса (FaPlus)
- **Сохранение**: Иконка дискеты (FaSave)
- **Отмена**: Иконка крестика (FaTimes)

## Обработка ошибок

### Валидация форм
- Проверка обязательных полей перед сохранением
- Отключение кнопок сохранения при незаполненных обязательных полях
- Индикация состояния загрузки (спиннеры)

### Подтверждение удаления
- Модальные окна подтверждения для удаления разделов и уроков
- Информативные сообщения о последствиях удаления

## Адаптивность

Интерфейс адаптирован для мобильных устройств:
- Адаптивные сетки (grid-cols-1 md:grid-cols-2)
- Мобильно-дружественные формы
- Оптимизированные кнопки и отступы

## API интеграция

### Используемые методы ktpService
- `ktpService.getKtpById(ktpId)` - Загрузка КТП
- `ktpService.updateKtp(ktpId, data)` - Обновление КТП
- `ktpService.updateLessonStatus(ktpId, lessonId, status)` - Обновление статуса урока

### Используемые методы systemService
- `systemService.getAcademicHourDuration()` - Получение настройки академического часа

## Пример использования

```typescript
import KtpTreeView from './components/KtpTreeView';

// В режиме редактирования
<KtpTreeView 
  ktpId={ktpId} 
  canEdit={user.role === 'TEACHER' || user.role === 'ADMIN'} 
/>

// В режиме просмотра
<KtpTreeView 
  ktpData={ktpData} 
  canEdit={false} 
/>
```

## Безопасность

- Проверка прав доступа на уровне пропсов компонента
- Валидация данных перед отправкой на сервер
- Подтверждение деструктивных действий (удаление)

## Производительность

- Локальное состояние для быстрой реакции UI
- Оптимистичные обновления с откатом при ошибках
- Минимальные перерендеры благодаря точечным обновлениям состояния

## Заключение

Интерфейс редактирования КТП обеспечивает полный цикл управления календарно-тематическим планированием с учетом системных настроек и требований к образовательному процессу. Автоматические расчеты и интеграция с системными настройками гарантируют консистентность данных по всей системе.
