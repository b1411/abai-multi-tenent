# Интеграция системы нагрузок с API отработанных часов

## Обзор

Система нагрузки преподавателей была успешно интегрирована с API для автоматического расчета отработанных часов. Теперь данные о нагрузке отображают реальные показатели, рассчитанные на основе расписания и фактически проведенных занятий.

## Изменения в бэкенде

### WorkloadService

#### Новые методы интеграции:

1. **recalculateAllWorkedHours(year, month)** - Пересчет отработанных часов для всех преподавателей
2. **syncTeacherWorkedHours(teacherId, year, month)** - Синхронизация часов конкретного преподавателя
3. **getRealTimeStats(filter)** - Получение статистики в реальном времени

#### Обогащение данных:

- Методы `findAll()`, `findOne()`, `findByTeacher()` теперь обогащают данные реальными часами из TeacherWorkedHoursService
- Месячные и квартальные данные генерируются автоматически на основе реальных расчетов
- Общие показатели (standardHours, actualHours, overtimeHours) обновляются из фактических данных

### WorkloadController

#### Новые эндпоинты:

```typescript
POST /workload/recalculate-all/:year/:month
POST /workload/sync-teacher-hours/:teacherId/:year/:month
GET /workload/real-time-stats
```

### Алгоритм интеграции:

1. **Получение данных расписания** - Из таблицы Schedule для конкретного преподавателя
2. **Расчет отработанных часов** - Через TeacherWorkedHoursService.getWorkedHoursByYear()
3. **Обогащение workload данных** - Замена статических данных реальными расчетами
4. **Генерация аналитики** - На основе реальных данных всех преподавателей

## Изменения во фронтенде

### Новые функции в workloadService.ts:

```typescript
// Пересчет всех отработанных часов
async recalculateAllWorkedHours(year: number, month: number): Promise<any>

// Синхронизация часов конкретного преподавателя
async syncTeacherHours(teacherId: number, year: number, month: number): Promise<any>

// Получение статистики в реальном времени
async getRealTimeStats(params?: WorkloadFilterParams): Promise<any>
```

### Обновления в Workload.tsx:

1. **Кнопка "Пересчитать все"** - Запускает пересчет для всех преподавателей за текущий месяц
2. **Кнопка "Синхронизировать"** - В модальном окне преподавателя для синхронизации его данных
3. **Реальные данные** - Все диаграммы и таблицы отображают актуальные часы
4. **Индикаторы загрузки** - Показывают процесс пересчета и синхронизации

### Улучшения UX:

- Loading состояния для длительных операций
- Подтверждение перед массовыми операциями
- Уведомления о результатах операций
- Обновление данных после синхронизации

## Схема работы интеграции

```
1. Пользователь нажимает "Пересчитать все"
   ↓
2. Вызывается WorkloadService.recalculateAllWorkedHours()
   ↓
3. Сервис получает всех преподавателей с workload записями
   ↓
4. Для каждого преподавателя вызывается TeacherWorkedHoursService.getWorkedHours()
   ↓
5. Обновляются данные в TeacherWorkload таблице
   ↓
6. Фронтенд получает обновленные данные и перерисовывает интерфейс
```

## Ключевые особенности

### Автоматический расчет:
- **scheduledHours** - Из расписания преподавателя
- **workedHours** - Фактически проведенные занятия
- **substitutedHours** - Часы замещения других преподавателей
- **substitutedByOthers** - Часы, замещенные другими

### Умная аналитика:
- Реальные тренды по месяцам и кварталам
- Точная статистика по предметам
- Показатели эффективности нагрузки
- Выявление перегруженных и недогруженных преподавателей

### Гибкая синхронизация:
- Массовый пересчет для всех преподавателей
- Индивидуальная синхронизация по преподавателям
- Автоматическое обновление при изменениях в расписании

## Настройки системы

### Академический час:
Продолжительность академического часа настраивается через SystemService:
- По умолчанию: 45 минут
- Диапазон: 20-90 минут
- Влияет на все расчеты нагрузки

### Периоды расчета:
- **Месячные** - Для детального анализа
- **Квартальные** - Для среднесрочного планирования  
- **Годовые** - Для общей оценки нагрузки

## Преимущества интеграции

1. **Точность данных** - Реальные показатели вместо статических
2. **Автоматизация** - Минимальное участие пользователя
3. **Актуальность** - Данные обновляются на основе текущего расписания
4. **Аналитика** - Глубокие инсайты о нагрузке преподавателей
5. **Масштабируемость** - Легко добавлять новые метрики

## Мониторинг и отладка

### Логирование:
- Процесс пересчета часов
- Ошибки синхронизации
- Статистика обработанных преподавателей

### Метрики:
- Время выполнения операций
- Количество обработанных записей
- Процент успешных синхронизаций

## Будущие улучшения

1. **Кэширование** - Для ускорения частых запросов
2. **Уведомления** - Автоматические оповещения об изменениях
3. **Планировщик** - Автоматический пересчет по расписанию
4. **Экспорт** - Детальные отчеты с реальными данными
5. **API webhooks** - Интеграция с внешними системами

## Использование

### Для администраторов:
1. Используйте "Пересчитать все" в начале каждого месяца
2. Проверяйте статистику на аномальные отклонения
3. Синхронизируйте данные преподавателей при изменениях в расписании

### Для HR:
1. Анализируйте нагрузку преподавателей для планирования
2. Выявляйте перегруженных сотрудников
3. Оптимизируйте распределение часов между преподавателями

### Для руководства:
1. Отслеживайте эффективность использования ресурсов
2. Планируйте кадровые потребности на основе реальных данных
3. Принимайте решения о корректировке нагрузки

Интеграция обеспечивает полную прозрачность и автоматизацию учета педагогической нагрузки, повышая качество управления образовательным процессом.
