# Автоматическое создание чатов для родителей

## Описание

Реализована система автоматического создания чатов для родителей с учителями их детей и администрацией (финансисты, HR-менеджеры, администраторы).

## Функциональность

### Бэкенд

#### Новые методы в ParentsService

1. **createDefaultChatsForParent(parentUserId: number)**
   - Создает чаты с учителями всех детей родителя
   - Создает чаты с администрацией (ADMIN, FINANCIST, HR)
   - Возвращает список созданных чатов

2. **getChildTeachers(studentId: number)**
   - Получает всех учителей ребенка через планы обучения группы
   - Убирает дубликаты учителей

3. **getAdministrationUsers()**
   - Получает пользователей с ролями ADMIN, FINANCIST, HR

4. **setupParentChats(parentUserId: number)**
   - Публичный метод для настройки чатов родителя

5. **refreshParentChats(parentUserId: number)**
   - Обновляет чаты родителя (например, при изменении состава учителей)

#### Новые API эндпоинты

- `POST /parents/me/setup-chats` - Настроить чаты для текущего родителя
- `POST /parents/me/refresh-chats` - Обновить чаты для текущего родителя
- `POST /parents/:id/setup-chats` - Настроить чаты для родителя (только админы)

#### Автоматическое создание

При создании нового родителя автоматически вызывается `createDefaultChatsForParent()` для создания чатов.

### Фронтенд

#### Новые сервисы

1. **parentService.ts**
   - `setupMyChats()` - Настроить чаты для текущего родителя
   - `refreshMyChats()` - Обновить чаты для текущего родителя
   - `getMyChildren()` - Получить детей текущего родителя

2. **useParent.ts** - Хук для работы с родительскими функциями

#### Обновленная страница "Мои дети"

- Добавлена кнопка "Настроить чаты" в заголовок страницы
- Показывает уведомления об успешной настройке или ошибках
- Адаптивный дизайн для мобильных устройств

## Типы создаваемых чатов

### Чаты с учителями
- Название: `{Имя учителя} {Фамилия учителя} - {Имя ребенка} {Фамилия ребенка}`
- Тип: Личный чат (не групповой)
- Участники: Родитель + Учитель

### Чаты с администрацией
- Название: `{Имя админа} {Фамилия админа} ({Роль})`
- Тип: Личный чат (не групповой)
- Участники: Родитель + Администратор
- Роли: Администратор, Финансист, HR-менеджер

## Скрипт для массовой настройки

Создан скрипт `setup-parent-chats.ts` для автоматической настройки чатов для всех существующих родителей.

### Запуск скрипта

```bash
cd apps/backend
npx ts-node scripts/setup-parent-chats.ts
```

### Функции скрипта

- Находит всех родителей в системе
- Для каждого родителя создает чаты с учителями детей и администрацией
- Показывает прогресс выполнения
- Логирует ошибки и успешные операции

## Обработка ошибок

- Если чат уже существует, система игнорирует ошибку и продолжает работу
- Ошибки логируются в консоль
- Фронтенд показывает понятные сообщения об ошибках пользователю

## Безопасность

- Все эндпоинты защищены авторизацией
- Родители могут настраивать только свои чаты
- Только администраторы и HR могут настраивать чаты для других родителей

## Адаптивность

- Кнопка настройки чатов адаптируется под размер экрана
- Уведомления корректно отображаются на мобильных устройствах
- Страница "Мои дети" полностью адаптивна

## Примеры использования

### Для родителя
1. Заходит на страницу "Мои дети"
2. Нажимает кнопку "Настроить чаты"
3. Система создает чаты с учителями и администрацией
4. Родитель переходит в раздел "Чаты" для общения

### Для администратора
1. Может настроить чаты для любого родителя через API
2. Может запустить массовую настройку через скрипт
3. Может обновить чаты при изменении состава учителей

## Технические детали

### База данных
- Использует существующую структуру чатов (ChatRoom, ChatParticipant, ChatMessage)
- Не требует миграций базы данных

### Производительность
- Чаты создаются асинхронно
- Обработка ошибок не блокирует основной процесс
- Дубликаты чатов автоматически игнорируются

### Масштабируемость
- Система поддерживает любое количество детей у родителя
- Поддерживает любое количество учителей у ребенка
- Поддерживает добавление новых административных ролей
