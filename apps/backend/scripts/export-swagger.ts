import { NestFactory } from '@nestjs/core';
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';
import path from 'path';
import fs from 'fs';
import { AppModule } from '../src/app.module'; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
import yaml from 'js-yaml'; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º js-yaml –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å YAML

async function exportSwagger() {
    try {
        console.log('üöÄ –ó–∞–ø—É—Å–∫ —ç–∫—Å–ø–æ—Ä—Ç–∞ Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏...');

        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º AppModule (ES modules)

        // –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–µ–∑ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
        const app = await NestFactory.create(AppModule, { logger: false });

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Swagger (–∏–¥–µ–Ω—Ç–∏—á–Ω–∞—è main.ts)
        const config = new DocumentBuilder()
            .setTitle('Multi-Tenant ABAI API')
            .setDescription(`
# üéì Multi-Tenant ABAI - –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º

## üìã –û–ø–∏—Å–∞–Ω–∏–µ
–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –∞—Ä–µ–Ω–¥—ã.

## üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
- üîê JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Å —Ä–æ–ª—è–º–∏ (ADMIN, TEACHER, STUDENT, PARENT, HR)
- üè´ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏ –∏ –∞—É–¥–∏—Ç–æ—Ä–∏—è–º–∏
- üìñ –£—á–µ–±–Ω—ã–µ –ø–ª–∞–Ω—ã –∏ —É—Ä–æ–∫–∏
- üìù –ú–∞—Ç–µ—Ä–∏–∞–ª—ã —É—Ä–æ–∫–æ–≤ (–ª–µ–∫—Ü–∏–∏, –≤–∏–¥–µ–æ, —Ç–µ—Å—Ç—ã, –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è)
- üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- üìä –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª —Å –æ—Ü–µ–Ω–∫–∞–º–∏ –∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å—é
- üí∞ –°–∏—Å—Ç–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Ä–æ–¥–∏—Ç–µ–ª–µ–π
- ü§ñ AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –≥–æ–ª–æ—Å–æ–≤—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
- üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

## üîë –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∑–∞—â–∏—â–µ–Ω–Ω—ã–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ JWT —Ç–æ–∫–µ–Ω –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ Authorization:
\`\`\`
Authorization: Bearer <your-jwt-token>
\`\`\`

## üë§ –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **ADMIN** - –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º —Å–∏—Å—Ç–µ–º—ã
- **HR** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –æ—Ç—á–µ—Ç–∞–º–∏
- **TEACHER** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–∫–∞–º–∏, –æ—Ü–µ–Ω–∫–∞–º–∏, –ø—Ä–æ—Å–º–æ—Ç—Ä –∂—É—Ä–Ω–∞–ª–æ–≤
- **STUDENT** - –ø—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –æ—Ü–µ–Ω–æ–∫, –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
- **PARENT** - –ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö —Å–≤–æ–∏—Ö –¥–µ—Ç–µ–π, –æ–ø–ª–∞—Ç–∞ –æ–±—É—á–µ–Ω–∏—è

## üì± –ú–æ–¥—É–ª–∏ —Å–∏—Å—Ç–µ–º—ã
- **Auth** - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- **Users** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- **Groups** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤
- **Classrooms** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏—è–º–∏
- **Study Plans** - –£—á–µ–±–Ω—ã–µ –ø–ª–∞–Ω—ã
- **Schedule** - –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π
- **Lessons** - –£—Ä–æ–∫–∏
- **Materials** - –ú–∞—Ç–µ—Ä–∏–∞–ª—ã —É—Ä–æ–∫–æ–≤
- **Lesson Results** - –≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª
- **Students** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏
- **Teachers** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º–∏
- **Parents** - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏
- **Payments** - –°–∏—Å—Ç–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- **AI Assistant** - AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –≥–æ–ª–æ—Å–æ–≤—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
      `)
            .setVersion('1.0.0')
            .addTag('Auth', '–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è')
            .addTag('Users', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏')
            .addTag('Groups', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏ —Å—Ç—É–¥–µ–Ω—Ç–æ–≤')
            .addTag('Classrooms', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏—è–º–∏')
            .addTag('Study Plans', '–£—á–µ–±–Ω—ã–µ –ø–ª–∞–Ω—ã')
            .addTag('Schedule', '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π')
            .addTag('Lessons', '–£—Ä–æ–∫–∏')
            .addTag('Materials', '–ú–∞—Ç–µ—Ä–∏–∞–ª—ã —É—Ä–æ–∫–æ–≤')
            .addTag('Lesson Results', '–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª —Å –æ—Ü–µ–Ω–∫–∞–º–∏ –∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å—é')
            .addTag('Students', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏')
            .addTag('Teachers', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º–∏')
            .addTag('Parents', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏')
            .addTag('Payments', '–°–∏—Å—Ç–µ–º–∞ –ø–ª–∞—Ç–µ–∂–µ–π')
            .addTag('AI Assistant', 'AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å –≥–æ–ª–æ—Å–æ–≤—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º')
            .addBearerAuth(
                {
                    type: 'http',
                    scheme: 'bearer',
                    bearerFormat: 'JWT',
                    name: 'JWT',
                    description: '–í–≤–µ–¥–∏—Ç–µ JWT —Ç–æ–∫–µ–Ω',
                    in: 'header',
                },
                'JWT-auth',
            )
            .addServer('http://localhost:3000', 'Development server')
            .addServer('https://api.abai.edu.kz', 'Production server')
            .setContact(
                'ABAI Support Team',
                'https://abai.edu.kz',
                'support@abai.edu.kz'
            )
            .setLicense('MIT', 'https://opensource.org/licenses/MIT')
            .build();

        // –°–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
        const document = SwaggerModule.createDocument(app, config);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const outputDir = path.resolve(process.cwd(), 'docs');
        const jsonPath = path.join(outputDir, 'swagger.json');
        const yamlPath = path.join(outputDir, 'swagger.yaml');

        // –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
        if (!fs.existsSync(outputDir)) {
            fs.mkdirSync(outputDir, { recursive: true });
            console.log(`üìÅ –°–æ–∑–¥–∞–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${outputDir}`);
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º JSON
        fs.writeFileSync(jsonPath, JSON.stringify(document, null, 2));
        console.log(`‚úÖ Swagger JSON —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ${jsonPath}`);

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ YAML —Ñ–æ—Ä–º–∞—Ç–µ
        fs.writeFileSync(yamlPath, yaml.dump(document));
        console.log(`‚úÖ Swagger YAML —Å–æ—Ö—Ä–∞–Ω–µ–Ω: ${yamlPath}`);

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        const stats = {
            paths: Object.keys(document.paths || {}).length,
            tags: (document.tags || []).length,
            components: Object.keys(document.components?.schemas || {}).length,
            fileSize: `${Math.round(fs.statSync(jsonPath).size / 1024)}KB`
        };

        console.log('\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:');
        console.log(`   üîó API —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤: ${stats.paths}`);
        console.log(`   üè∑Ô∏è  –¢–µ–≥–æ–≤: ${stats.tags}`);
        console.log(`   üìã –°—Ö–µ–º –¥–∞–Ω–Ω—ã—Ö: ${stats.components}`);
        console.log(`   üìÑ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ${stats.fileSize}`);

        await app.close();
        console.log('\nüéâ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!');

    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ Swagger:', error.message);
        process.exit(1);
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º —ç–∫—Å–ø–æ—Ä—Ç
exportSwagger().catch(error => {
    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error.message);
    process.exit(1);
});
