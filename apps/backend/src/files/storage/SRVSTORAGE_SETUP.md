# –ü–æ—à–∞–≥–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ srvstorage.kz –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤

## –®–∞–≥ 1: –í–æ–π—Ç–∏ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è

1. –û—Ç–∫—Ä–æ–π https://panel.srvstorage.kz (–∏–ª–∏ https://cp.selcloud.ru)
2. –í–æ–π–¥–∏ –∏—Å–ø–æ–ª—å–∑—É—è —Å–≤–æ–∏ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

## –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ bucket

1. –í –º–µ–Ω—é —Å–ª–µ–≤–∞ –Ω–∞–π–¥–∏ —Ä–∞–∑–¥–µ–ª **"–û–±—ä–µ–∫—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ"** –∏–ª–∏ **"S3 Storage"**
2. –ù–∞–π–¥–∏ bucket —Å –∏–º–µ–Ω–µ–º **`abai-bucket`**
3. –ï—Å–ª–∏ bucket –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - —Å–æ–∑–¥–∞–π –µ–≥–æ:
   - –ù–∞–∂–º–∏ "–°–æ–∑–¥–∞—Ç—å bucket" –∏–ª–∏ "Create bucket"
   - –ò–º—è: `abai-bucket`
   - –†–µ–≥–∏–æ–Ω: `kz-1`
   - –ù–∞–∂–º–∏ "–°–æ–∑–¥–∞—Ç—å"

## –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å/–°–æ–∑–¥–∞—Ç—å Access Key

1. –í –º–µ–Ω—é –Ω–∞–π–¥–∏ —Ä–∞–∑–¥–µ–ª **"–ö–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞"** –∏–ª–∏ **"Access Keys"** –∏–ª–∏ **"–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ"**
2. –ü–æ—Å–º–æ—Ç—Ä–∏ —Å–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–ª—é—á–µ–π:
   - –ï—Å—Ç—å –∫–ª—é—á —Å ID `f3118678250e4306bedbb370f83e94d7`?

### –ï—Å–ª–∏ –∫–ª—é—á –ù–ï —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
3. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π –∫–ª—é—á:
   - –ù–∞–∂–º–∏ "–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á" –∏–ª–∏ "Create Access Key"
   - –°–∫–æ–ø–∏—Ä—É–π **Access Key ID** (—Ç–∏–ø–∞: `abc123...`)
   - –°–∫–æ–ø–∏—Ä—É–π **Secret Access Key** (—Ç–∏–ø–∞: `xyz789...`)
   - –í–ê–ñ–ù–û: Secret Key –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑!

4. –û–±–Ω–æ–≤–∏ `.env` —Ñ–∞–π–ª —Å –Ω–æ–≤—ã–º–∏ –∫–ª—é—á–∞–º–∏:
   ```env
   AWS_ACCESS_KEY_ID=–Ω–æ–≤—ã–π-access-key-id
   AWS_SECRET_ACCESS_KEY=–Ω–æ–≤—ã–π-secret-key
   ```

### –ï—Å–ª–∏ –∫–ª—é—á —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
3. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω (–Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω)
4. –ï—Å–ª–∏ –∑–∞–±—ã–ª Secret Key - –ø—Ä–∏–¥–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á (—Å–º. –≤—ã—à–µ)

## –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –∫–ª—é—á–∞

### –í–∞—Ä–∏–∞–Ω—Ç A: –í —Ä–∞–∑–¥–µ–ª–µ Access Keys (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
1. –ù–∞–π–¥–∏ —Å–≤–æ–π Access Key –≤ —Å–ø–∏—Å–∫–µ
2. –ù–∞–∂–º–∏ –Ω–∞ –Ω–µ–≥–æ –∏–ª–∏ –∫–Ω–æ–ø–∫—É "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" / "Edit"
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ –≤–∫–ª—é—á–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∞:
   - ‚úÖ **–ß—Ç–µ–Ω–∏–µ bucket** (`s3:ListBucket`, `s3:HeadBucket`)
   - ‚úÖ **–ß—Ç–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤** (`s3:GetObject`)
   - ‚úÖ **–ó–∞–ø–∏—Å—å –æ–±—ä–µ–∫—Ç–æ–≤** (`s3:PutObject`)
   - ‚úÖ **–£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤** (`s3:DeleteObject`)
4. –°–æ—Ö—Ä–∞–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç B: –ß–µ—Ä–µ–∑ IAM (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
1. –ù–∞–π–¥–∏ —Ä–∞–∑–¥–µ–ª **IAM** –∏–ª–∏ **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º**
2. –ù–∞–π–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Ç–≤–æ–∏–º Access Key
3. –î–æ–±–∞–≤—å –ø–æ–ª–∏—Ç–∏–∫—É —Å –ø—Ä–∞–≤–∞–º–∏ –Ω–∞ bucket `abai-bucket`:
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Effect": "Allow",
         "Action": [
           "s3:ListBucket",
           "s3:GetObject",
           "s3:PutObject",
           "s3:DeleteObject"
         ],
         "Resource": [
           "arn:aws:s3:::abai-bucket",
           "arn:aws:s3:::abai-bucket/*"
         ]
       }
     ]
   }
   ```

## –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ bucket

–≠—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã —Ñ–∞–π–ª—ã –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –ø—Ä—è–º—ã–º —Å—Å—ã–ª–∫–∞–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫).

### –í–∞—Ä–∏–∞–Ω—Ç 1: –°–¥–µ–ª–∞—Ç—å bucket –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—É–±–ª–∏—á–Ω—ã–º
1. –í—ã–±–µ—Ä–∏ bucket `abai-bucket`
2. –ü–µ—Ä–µ–π–¥–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ bucket
3. –ù–∞–π–¥–∏ —Ä–∞–∑–¥–µ–ª **"–ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø"** –∏–ª–∏ **"Public Access"**
4. –í–∫–ª—é—á–∏ –æ–ø—Ü–∏—é **"–†–∞–∑—Ä–µ—à–∏—Ç—å –ø—É–±–ª–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ"** –∏–ª–∏ **"Allow public read"**
5. –°–æ—Ö—Ä–∞–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Bucket Policy (–±–æ–ª–µ–µ –≥–∏–±–∫–∏–π –≤–∞—Ä–∏–∞–Ω—Ç)
1. –í—ã–±–µ—Ä–∏ bucket `abai-bucket`
2. –ù–∞–π–¥–∏ —Ä–∞–∑–¥–µ–ª **"–ü–æ–ª–∏—Ç–∏–∫–∏ –¥–æ—Å—Ç—É–ø–∞"** –∏–ª–∏ **"Bucket Policy"**
3. –í—Å—Ç–∞–≤—å —Å–ª–µ–¥—É—é—â—É—é –ø–æ–ª–∏—Ç–∏–∫—É:
   ```json
   {
     "Version": "2012-10-17",
     "Statement": [
       {
         "Sid": "PublicReadGetObject",
         "Effect": "Allow",
         "Principal": "*",
         "Action": "s3:GetObject",
         "Resource": "arn:aws:s3:::abai-bucket/*"
       }
     ]
   }
   ```
4. –°–æ—Ö—Ä–∞–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ß–µ—Ä–µ–∑ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ACL
1. –í—ã–±–µ—Ä–∏ bucket `abai-bucket`
2. –ù–∞–π–¥–∏ —Ä–∞–∑–¥–µ–ª **"ACL"** –∏–ª–∏ **"–°–ø–∏—Å–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º"**
3. –ù–∞–π–¥–∏ –≥—Ä—É–ø–ø—É **"–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏"** –∏–ª–∏ **"Everyone"**
4. –í–∫–ª—é—á–∏ –ø—Ä–∞–≤–æ **"–ß—Ç–µ–Ω–∏–µ"** –∏–ª–∏ **"Read"**
5. –°–æ—Ö—Ä–∞–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è

## –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ CORS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—à—å –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ñ–∞–π–ª—ã –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞, –Ω–∞—Å—Ç—Ä–æ–π CORS:

1. –í—ã–±–µ—Ä–∏ bucket `abai-bucket`
2. –ù–∞–π–¥–∏ —Ä–∞–∑–¥–µ–ª **"CORS"**
3. –î–æ–±–∞–≤—å –ø—Ä–∞–≤–∏–ª–æ:
   ```json
   [
     {
       "AllowedHeaders": ["*"],
       "AllowedMethods": ["GET", "PUT", "POST", "DELETE"],
       "AllowedOrigins": ["*"],
       "ExposeHeaders": ["ETag"],
       "MaxAgeSeconds": 3000
     }
   ]
   ```
4. –°–æ—Ö—Ä–∞–Ω–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è

## –®–∞–≥ 7: –ù–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ endpoint URL

–í –∞–¥–º–∏–Ω–∫–µ –Ω–∞–π–¥–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ endpoint:

1. –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö bucket –∏–ª–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞–π–¥–∏:
   - **API Endpoint** (–¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ –∫–æ–¥)
   - **Public URL** (–¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä)

2. –í–æ–∑–º–æ–∂–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–ª—è srvstorage.kz:
   - API: `https://s3.kz-1.srvstorage.kz`
   - Public (vHosted): `https://abai-bucket.s3.kz-1.storage.selcloud.ru`
   - Public (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞): `https://abai-bucket.s3.kz-1.srvstorage.kz`

3. –û–±–Ω–æ–≤–∏ `.env` –µ—Å–ª–∏ URL –æ—Ç–ª–∏—á–∞—é—Ç—Å—è:
   ```env
   AWS_S3_ENDPOINT=https://–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π-api-endpoint
   AWS_S3_PUBLIC_URL=https://–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π-public-url
   ```

## –®–∞–≥ 8: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É

–ü–æ—Å–ª–µ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫, –∑–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç:

```bash
npx tsx apps/backend/src/files/storage/test-s3-connection.ts
```

### –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
‚úÖ Bucket –¥–æ—Å—Ç—É–ø–µ–Ω
‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω
‚úÖ –§–∞–π–ª –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ URL (HTTP 200)
‚úÖ –§–∞–π–ª —É–¥–∞–ª–µ–Ω
üéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!
```

## Troubleshooting

### ‚ùå Access Denied –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤ –¥–ª—è –∑–∞–ø–∏—Å–∏
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å –®–∞–≥ 4 - –¥–æ–±–∞–≤—å –ø—Ä–∞–≤–∞ `s3:PutObject`

### ‚ùå Bucket –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint –∏–ª–∏ credentials
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å –®–∞–≥ 7 - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ª–∏ endpoint –≤ `.env`

### ‚ùå HTTP 403 –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ —Ñ–∞–π–ª—É
**–ü—Ä–æ–±–ª–µ–º–∞:** –§–∞–π–ª—ã –Ω–µ –ø—É–±–ª–∏—á–Ω—ã–µ
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å –®–∞–≥ 5 - –Ω–∞—Å—Ç—Ä–æ–π –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø

### ‚ùå HTTP 404 –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ —Ñ–∞–π–ª—É
**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π public URL
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å –®–∞–≥ 7 - –ø–æ–ø—Ä–æ–±—É–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ URL

## –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –∫–æ–¥–∞

–ú–æ–∂–µ—à—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å bucket —á–µ—Ä–µ–∑ AWS CLI –∏–ª–∏ curl:

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ bucket
curl -I https://s3.kz-1.srvstorage.kz/abai-bucket/

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ (–∑–∞–º–µ–Ω–∏ –∫–ª—é—á–∏ –Ω–∞ —Å–≤–æ–∏)
curl -X PUT \
  --aws-sigv4 "aws:amz:kz-1:s3" \
  --user "ACCESS_KEY:SECRET_KEY" \
  -H "Content-Type: text/plain" \
  -d "test content" \
  https://s3.kz-1.srvstorage.kz/abai-bucket/test.txt
```

## –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è:
1. –°–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
2. –°–∫–æ–ø–∏—Ä—É–π —Ç–æ—á–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –∏–∑ —Ç–µ—Å—Ç–∞
3. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≤—Å–µ –∫–ª—é—á–∏ –∏ URLs –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ `.env` (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤!)

---

**–°–æ–≤–µ—Ç:** –ï—Å–ª–∏ —Å–æ–≤—Å–µ–º –Ω–µ —Ä–∞–∑–±–µ—Ä–µ—à—å—Å—è —Å –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏ - –ø–æ–ø—Ä–æ–±—É–π —Å–æ–∑–¥–∞—Ç—å –ù–û–í–´–ô bucket —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å —Å –æ–ø—Ü–∏–µ–π "–ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø" —Å—Ä–∞–∑—É –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏. –≠—Ç–æ –ø—Ä–æ—â–µ, —á–µ–º –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∏ –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º bucket.
