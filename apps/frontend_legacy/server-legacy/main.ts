import express from 'express';
import axios from 'axios';
import cors from 'cors';
import dotenv from 'dotenv';
import multer from 'multer';
import FormData from 'form-data';
import openai from 'openai';

dotenv.config();

const openaiClient = new openai({
  apiKey: process.env.OPENAI_API_KEY,
});

const app = express();

app.use(express.json());
app.use(cors({
  origin: ["https://abai.live", "https://backend.ab-ai.kz", "http://localhost:3000"],
  methods: ["GET", "POST", "PUT", "DELETE"],
  allowedHeaders: ["Content-Type", "Authorization"],
}));

const router = express.Router();

const upload = multer();

router.get('/init-session', async (req, res) => {
  const apiKey = process.env.OPENAI_API_KEY;
  try {
    const response = await axios.post('https://api.openai.com/v1/realtime/sessions', {
      "model": "gpt-4o-realtime-preview",
      input_audio_transcription: {
        language: "ru",
        model: "gpt-4o-mini-transcribe",
      },
      instructions: "Ð’Ð¾Ñ‚ Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¹ Ð´Ð»Ñ AI-ÑƒÑ‡Ð¸Ñ‚ÐµÐ»Ñ *ÐÐ¹Ð¶Ð°Ð½ Ð¡ÑƒÐ»Ñ‚Ð°Ð½Ð¾Ð²Ð½Ñ‹, Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»Ñ **Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ¸*. Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¸ ÑÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½ ÑÑ‚Ð¸Ð»ÑŒ Ð¿Ð¾Ð´ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚: --- ### * Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ AI - ÑƒÑ‡Ð¸Ñ‚ÐµÐ»Ñ ÐÐ¹Ð¶Ð°Ð½ Ð¡ÑƒÐ»Ñ‚Ð°Ð½Ð¾Ð²Ð½Ñ‹, Ð¿Ñ€ÐµÐ¿Ð¾Ð´Ð°Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ¸ * --- #### * ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ * ÐšÐ°Ð¶Ð´Ñ‹Ð¹ ÑƒÑ€Ð¾Ðº Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ð¾Ð³Ð¾ Ð¸ Ð¾Ð±Ð¾Ð´Ñ€ÑÑŽÑ‰ÐµÐ³Ð¾ Ð¿Ñ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ñ: â Â«Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ, Ð´Ð¾Ñ€Ð¾Ð³Ð¾Ð¹ ÑƒÑ‡ÐµÐ½Ð¸Ðº! Ð Ð°Ð´Ð° Ð²Ð°Ñ Ð²Ð¸Ð´ÐµÑ‚ÑŒ. ðŸ˜Š â Ð¡ÐºÐ°Ð¶Ð¸Ñ‚Ðµ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ñ‡Ñ‚Ð¾ Ð²Ñ‹ ÑÐµÐ³Ð¾Ð´Ð½Ñ ÑƒÐ¶Ðµ ÑƒÑÐ¿ÐµÐ»Ð¸ Ð¿Ñ€Ð¾Ð¹Ñ‚Ð¸ Ð¿Ð¾ Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐµ ? Ð•ÑÑ‚ÑŒ Ð»Ð¸ Ñ‡Ñ‚Ð¾ - Ñ‚Ð¾, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚ÐµÐ»Ð¾ÑÑŒ Ð±Ñ‹ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¸Ð»Ð¸ Ð¾Ð±ÑŠÑÑÐ½Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ ?Â» --- ### * ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð·Ð°Ð´Ð°Ñ‡Ð°:* â€¢â  â ÐžÐ±ÑŠÑÑÐ½ÑÑ‚ÑŒ * Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ‚ÐµÐ¼Ñ‹ ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿Ð¾ ÑˆÐºÐ¾Ð»ÑŒÐ½Ð¾Ð¹ Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ðµ *, Ð¿Ð¾ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸ Ð¿Ð¾ÑÑ‚Ð°Ð¿Ð½Ð¾. â€¢â  â ÐÐµ Ð¾Ñ‚ÐºÐ»Ð¾Ð½ÑÑ‚ÑŒÑÑ Ð½Ð° Ñ‚ÐµÐ¼Ñ‹, Ð½Ðµ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ñ * Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐ¾Ð¹ *. â€¢â  â ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ñ‚ÑŒ ÑƒÑ‡ÐµÐ±Ð½Ñ‹Ð¹ Ñ‚ÐµÐ¼Ð¿, ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ ÑƒÑ€Ð¾Ð²Ð½ÑŽ ÑƒÑ‡ÐµÐ½Ð¸ÐºÐ°. --- ### * Ð¡Ñ‚Ð¸Ð»ÑŒ Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:* â€¢â  â Ð‘Ñ‹Ñ‚ÑŒ * Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ð¾Ð¹, Ð´Ð¾Ð±Ñ€Ð¾Ð¶ÐµÐ»Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ð¹ Ð¸ Ñ‚ÐµÑ€Ð¿ÐµÐ»Ð¸Ð²Ð¾Ð¹ *. â€¢â  â Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ * Ð¿Ð¾Ð½ÑÑ‚Ð½Ñ‹Ð¹, Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ ÑÐ·Ñ‹Ðº *, ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽÑ‰Ð¸Ð¹ Ð²Ð¾Ð·Ñ€Ð°ÑÑ‚Ñƒ ÑƒÑ‡ÐµÐ½Ð¸ÐºÐ°. â€¢â  â ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°Ñ‚ÑŒ Ð¸Ð½Ñ‚ÐµÑ€ÐµÑ Ðº Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÐµ, Ñ€Ð°Ð·Ð²Ð¸Ð²Ð°Ñ * ÑƒÐ²ÐµÑ€ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ * Ð² ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… ÑÐ¸Ð»Ð°Ñ…. --- ### * ÐžÐ±ÑŠÑÑÐ½ÐµÐ½Ð¸Ðµ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð°:* â€¢â  â Ð”Ð°Ð²Ð°Ñ‚ÑŒ * Ñ‡ÐµÑ‚ÐºÐ¸Ðµ, ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¸ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ðµ Ð¾Ð±ÑŠÑÑÐ½ÐµÐ½Ð¸Ñ *. â€¢â  â Ð Ð°Ð·Ð±Ð¸Ð²Ð°Ñ‚ÑŒ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ðµ Ñ‚ÐµÐ¼Ñ‹ Ð½Ð° * Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ðµ Ð¸ Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ñ‹Ðµ ÑˆÐ°Ð³Ð¸ *. â€¢â  â Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ * Ð½Ð°Ð³Ð»ÑÐ´Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ñ‹, Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ð¸ * (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ð¿Ð¸Ñ†Ñ†Ñ‹ Ð´Ð»Ñ Ð´Ñ€Ð¾Ð±ÐµÐ¹, Ð»ÐµÑÑ‚Ð½Ð¸Ñ†Ñ‹ Ð´Ð»Ñ ÑƒÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ð¹ Ð¸ Ñ‚.Ð´.). â€¢â  â Ð£Ñ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ð½Ñ‹Ðµ ÑÑ‚Ð¸Ð»Ð¸ Ð²Ð¾ÑÐ¿Ñ€Ð¸ÑÑ‚Ð¸Ñ(Ð²Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹, ÑÐ»ÑƒÑ…Ð¾Ð²Ð¾Ð¹, Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹). --- ### * ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ ÑƒÑÐ²Ð¾ÐµÐ½Ð¸Ñ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ð°Ð»Ð°:* â€¢â  â ÐŸÐ¾ÑÐ»Ðµ Ð¾Ð±ÑŠÑÑÐ½ÐµÐ½Ð¸Ñ Ñ‚ÐµÐ¼Ñ‹ Ð·Ð°Ð´Ð°Ð²Ð°Ñ‚ÑŒ * Ñ‚Ñ€Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ° *: - * ÐžÐ´Ð¸Ð½ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ * â€” Ð½Ð° Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ñ Ð¸Ð»Ð¸ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°. - * ÐžÐ´Ð¸Ð½ Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ * â€” Ð½Ð° Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ. - * ÐžÐ´Ð¸Ð½ Ð±Ð¾Ð»ÐµÐµ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ð¹ Ð¸Ð»Ð¸ Ñ Ð¿Ð¾Ð´Ð²Ð¾Ñ…Ð¾Ð¼ * â€” Ð´Ð»Ñ Ñ€Ð°Ð·Ð²Ð¸Ñ‚Ð¸Ñ Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð¸Ñ. â€¢â  â Ð’Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ: - Ð¡ Ð²Ñ‹Ð±Ð¾Ñ€Ð¾Ð¼ Ð¾Ñ‚Ð²ÐµÑ‚Ð°. - ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ. - ÐŸÑ€Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð·Ð°Ð´Ð°Ð½Ð¸Ñ. â€¢â  â * Ð’Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑÐ»ÑƒÑˆÐ°Ñ‚ÑŒ * Ð¸ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚. --- ### * ÐžÑ†ÐµÐ½Ð¸Ð²Ð°Ð½Ð¸Ðµ:* â€¢â  â ÐŸÐ¾ÑÐ»Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð² â€” * Ð¾Ð±ÑŠÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ Ð¾Ñ†ÐµÐ½Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ *. â€¢â  â Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ * Ð¿Ð¾Ð½ÑÑ‚Ð½ÑƒÑŽ ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ *: - Ð¡Ð»Ð¾Ð²ÐµÑÐ½Ð°Ñ Ð¿Ð¾Ñ…Ð²Ð°Ð»Ð°: Â«ÐœÐ¾Ð»Ð¾Ð´ÐµÑ†!Â», Â«Ð¥Ð¾Ñ€Ð¾ÑˆÐ¾ ÑÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑÑ!Â» - Ð‘Ð°Ð»Ð»ÑŒÐ½Ð°Ñ Ð¾Ñ†ÐµÐ½ÐºÐ°: Ð¾Ñ‚ 1 Ð´Ð¾ 5. â€¢â  â Ð”Ð°Ð²Ð°Ñ‚ÑŒ * ÐºÐ¾Ð½ÑÑ‚Ñ€ÑƒÐºÑ‚Ð¸Ð²Ð½ÑƒÑŽ Ð¾Ð±Ñ€Ð°Ñ‚Ð½ÑƒÑŽ ÑÐ²ÑÐ·ÑŒ *: - ÐžÑ‚Ð¼ÐµÑ‡Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¾ÑÑŒ Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾. - ÐÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ð¾ Ð¿Ð¾Ð´ÑÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ, Ð³Ð´Ðµ Ð½ÑƒÐ¶Ð½Ð¾ Ð¿Ð¾Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒÑÑ. --- ### * ÐœÐ¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ Ð¸ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°:* â€¢â  â ÐŸÐ¾Ð¾Ñ‰Ñ€ÑÑ‚ÑŒ Ð·Ð°Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹: Â«ÐžÑ‡ÐµÐ½ÑŒ Ñ…Ð¾Ñ€Ð¾ÑˆÐ¸Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ, Ð´Ð°Ð²Ð°Ð¹ Ñ€Ð°Ð·Ð±ÐµÑ€Ñ‘Ð¼ÑÑ Ð²Ð¼ÐµÑÑ‚Ðµ!Â» â€¢â  â ÐÐ¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ ÐºÑ€Ð¸Ñ‚Ð¸ÐºÐ¾Ð²Ð°Ñ‚ÑŒ.Ð’Ð¼ÐµÑÑ‚Ð¾ Â«Ð½ÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Â» â€” Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ: > Â«Ð¢Ñ‹ Ð±Ñ‹Ð» Ð¾Ñ‡ÐµÐ½ÑŒ Ð±Ð»Ð¸Ð·ÐºÐ¾.Ð”Ð°Ð²Ð°Ð¹ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð²Ð¼ÐµÑÑ‚Ðµ ÐµÑ‰Ñ‘ Ñ€Ð°Ð·!Â» â€¢â  â Ð”ÐµÐ»Ð°Ñ‚ÑŒ Ð°ÐºÑ†ÐµÐ½Ñ‚Ñ‹ Ð½Ð° ÑƒÑÐ¿ÐµÑ…Ð°Ñ…, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¸Ñ…. --- ### * ÐŸÑ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»Ð¸Ð·Ð¼:* â€¢â  â ÐžÐ±Ñ‰Ð°Ñ‚ÑŒÑÑ * ÑƒÐ²Ð°Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸ Ð²Ð½Ð¸Ð¼Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ *. â€¢â  â ÐÐµ Ð¾Ð±ÑÑƒÐ¶Ð´Ð°Ñ‚ÑŒ * Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ñ‹ Ð¸Ð»Ð¸ Ð¿Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð½Ð¸Ðµ Ñ‚ÐµÐ¼Ñ‹ *. â€¢â  â ÐŸÐ¾Ð´ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°Ñ‚ÑŒÑÑ Ð¿Ð¾Ð´ * Ñ‚ÐµÐ¼Ð¿ Ð¸ ÑƒÑ€Ð¾Ð²ÐµÐ½ÑŒ ÑƒÑ‡ÐµÐ½Ð¸ÐºÐ° *. --- ### * Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸:* â€¢â  â Ð¡Ð²ÑÐ·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¼Ð°Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸ÐºÑƒ Ñ * Ð¶Ð¸Ð·Ð½ÑŒÑŽ *: - Â«Ð—Ð½Ð°ÐµÑˆÑŒ, Ð´Ñ€Ð¾Ð±Ð¸ Ñ‡Ð°ÑÑ‚Ð¾ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð°ÑŽÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð´ÐµÐ»ÐµÐ½Ð¸Ð¸ Ð´ÐµÐ½ÐµÐ³, Ð¿Ð¸Ñ†Ñ†Ñ‹ Ð¸Ð»Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸!Â» â€¢â  â ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€ÑÑ‚ÑŒ Ñ€Ð°Ð½ÐµÐµ Ð¸Ð·ÑƒÑ‡ÐµÐ½Ð½Ð¾Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð·Ð°ÐºÑ€ÐµÐ¿Ð»ÑÑ‚ÑŒ Ð·Ð½Ð°Ð½Ð¸Ñ. â€¢â  â Ð£Ñ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ * Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¾ÑÐ¾Ð±ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ * ÑƒÑ‡ÐµÐ½Ð¸ÐºÐ° â€” Ð½Ðµ Ñ‚Ð¾Ñ€Ð¾Ð¿Ð¸Ñ‚ÑŒ, ÐµÑÐ»Ð¸ Ð¾Ð½ Ð´ÑƒÐ¼Ð°ÐµÑ‚; Ð½Ðµ Ð´Ð°Ð²Ð¸Ñ‚ÑŒ, ÐµÑÐ»Ð¸ Ð¾Ð½ Ð¾ÑˆÐ¸Ð±Ð°ÐµÑ‚ÑÑ."
    }, {
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Content-Type": "application/json",
      },
    });
    res.json(response.data);
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Failed to get ephemeral token' });
  }
});

router.post('/openai-responses', upload.any(), async (req, res) => {
  const isCSVOrExcel = (filename: string) => {
    return filename.endsWith('.csv') || filename.endsWith('.xlsx') || filename.endsWith('.xls');
  }

  const apiKey = process.env.OPENAI_API_KEY;
  const { message, scenario } = req.body;
  const files = req.files;

  try {
    const file_ids: { file_id: string, tools: { type: "code_interpreter" | "file_search" }[] }[] = files && Array.isArray(files)
      ? await Promise.all(files.map(async (file) => {
        // Convert Buffer to a File-like object for OpenAI API compatibility
        const fileLike = new File([file.buffer], file.originalname || 'upload', { type: file.mimetype || 'application/octet-stream' });
        const file_id = await openaiClient.files.create({
          file: fileLike,
          purpose: "assistants",
        });
        return {
          file_id: file_id.id,
          tools: [isCSVOrExcel(file.originalname || '') ? { type: "code_interpreter" } : { type: "file_search" }]
        };
      }))
      : [];

    const thread = await openaiClient.beta.threads.create({
      messages: [
        {
          role: "user",
          content: scenario + "\n\n" + message,
          attachments: file_ids.map((file_id) => ({
            tools: file_id.tools,
            file_id: file_id.file_id
          }))
        }
      ]
    });

    const run = await openaiClient.beta.threads.runs.createAndPoll(thread.id, {
      assistant_id: "asst_mBU9RKp3RiFZF614CEWLn7fP",
    })

    if (run.status === "completed") {
      const response = await openaiClient.beta.threads.messages.list(thread.id)
      if (response.data[0].content) {
        for (const content of response.data[0].content) {
          if (content.type === "text") {
            res.json(content.text.value);
            return;
          }
        }
      }
    }

    res.json();
  } catch (error) {
    console.error(error);
    res.status(500).json({ error: 'Failed to get OpenAI response' });
  }
});

app.use("/api/sps-chat", router);

export default app;